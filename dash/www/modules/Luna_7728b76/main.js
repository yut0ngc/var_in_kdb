define(["Handlebars","QuickBase","moment","backbone","css!./css/app.css"],function(t,e,n,r){var a,i=this&&this.__extends||(a=function(t,e){return(a=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}))(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),p=this&&this.__assign||function(){return(p=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},f=this&&this.__awaiter||function(t,o,l,s){return new(l=l||Promise)(function(n,e){function r(t){try{i(s.next(t))}catch(t){e(t)}}function a(t){try{i(s.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?n(t.value):((e=t.value)instanceof l?e:new l(function(t){t(e)})).then(r,a)}i((s=s.apply(t,o||[])).next())})},d=this&&this.__generator||function(r,a){var i,o,l,s={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(n){return function(t){var e=[n,t];if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(l=2&e[0]?o.return:e[0]?o.throw||((l=o.return)&&l.call(o),0):o.next)&&!(l=l.call(o,e[1])).done)return l;switch(o=0,(e=l?[2&e[0],l.value]:e)[0]){case 0:case 1:l=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,o=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(l=0<(l=s.trys).length&&l[l.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!l||e[1]>l[0]&&e[1]<l[3]))s.label=e[1];else if(6===e[0]&&s.label<l[1])s.label=l[1],l=e;else{if(!(l&&s.label<l[2])){l[2]&&s.ops.pop(),s.trys.pop();continue}s.label=l[2],s.ops.push(e)}}e=a.call(r,s)}catch(t){e=[6,t],o=0}finally{i=l=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},o=(l.getComponentDefinition=function(t){var e,n;if(0<_.keys(t.settingsModel.attributes).length)for(n=l.upgrades.indexOf(_.find(l.upgrades,{version:t.settingsModel.get("version")}))+1;n<l.upgrades.length;n+=1)(e=l.upgrades[n]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return{appArgs:{json:{Luna:{Data:"",Title:"",Subtitle:"",Time:0,ILatitude:"-27",ILongitude:"133",IZoom:"3",Latitude:"-27",Longitude:"133",Zoom:"3",Layers:[]}},schema:{type:"object",title:"Properties",properties:{Luna:{type:"object",title:"Luna",properties:{Title:{type:"string",title:"Title",default:"",format:"string"},Subtitle:{type:"string",title:"Subtitle",default:"",format:"string"},Time:{type:"number",title:"Time",default:0},ILatitude:{type:"string",title:"ILatitude",default:"",format:"string"},ILongitude:{type:"string",title:"ILongitude",default:"",format:"string"},IZoom:{type:"string",title:"IZoom",default:"",format:"string"},Latitude:{type:"string",title:"Latitude",default:"",format:"string"},Longitude:{type:"string",title:"Longitude",default:"",format:"string"},Zoom:{type:"string",title:"Zoom",default:"",format:"string"},Layers:{type:"array",format:"object",title:"Layers",options:{collapsed:!0,reset:!0},items:{type:"object",title:"Layer",properties:{Enabled:{default:!1,type:"boolean",propertyOrder:1,format:"checkbox"},Name:{default:"",type:"string",propertyOrder:2},Type:{type:"string",title:"Type",enum:["Polygon","Lightning","AVC","MultiPolygon","Point","MultiPoint","LineString","MultiLineString","GeometryCollection","NAC","DSLAM","LineSegment","Raw","Election"],propertyOrder:3},LayerId:{default:"",type:"string",propertyOrder:4},Arg1:{default:"",type:"string",propertyOrder:5},Arg2:{default:"",type:"string",propertyOrder:6},Arg3:{default:"",type:"string",propertyOrder:7}}}},UserInput:{type:"string",title:"User Input"}}}}}}}},l);function l(){}o.upgrades=[{fn:function(t){}}];s.app=t.template({compiler:[8,">= 4.3.0"],main:function(t,e,n,r,a){var i,o=null!=e?e:t.nullContext||{},l=t.hooks.helperMissing,s="function",u=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="luna">\n    <div class="luna">\n        <iframe class="'+u(typeof(i=null!=(i=t(n,"frameID")||(null!=e?t(e,"frameID"):e))?i:l)==s?i.call(o,{name:"frameID",hash:{},data:a,loc:{start:{line:3,column:23},end:{line:3,column:34}}}):i)+'" id="luna-iframe" src="'+u(typeof(i=null!=(i=t(n,"url")||(null!=e?t(e,"url"):e))?i:l)==s?i.call(o,{name:"url",hash:{},data:a,loc:{start:{line:3,column:58},end:{line:3,column:65}}}):i)+"#loc="+u(typeof(i=null!=(i=t(n,"lat")||(null!=e?t(e,"lat"):e))?i:l)==s?i.call(o,{name:"lat",hash:{},data:a,loc:{start:{line:3,column:70},end:{line:3,column:77}}}):i)+","+u(typeof(i=null!=(i=t(n,"lng")||(null!=e?t(e,"lng"):e))?i:l)==s?i.call(o,{name:"lng",hash:{},data:a,loc:{start:{line:3,column:78},end:{line:3,column:85}}}):i)+","+u(typeof(i=null!=(i=t(n,"zoom")||(null!=e?t(e,"zoom"):e))?i:l)==s?i.call(o,{name:"zoom",hash:{},data:a,loc:{start:{line:3,column:86},end:{line:3,column:94}}}):i)+'">\n\n            \n        </iframe>\n    </div>\n</div>'},useData:!0});var y=s;function s(){}var u;e.Tools;function c(t){var e=u.call(this,t)||this;return e.status={},e.api=t.api,e.el=t.el,e.iframeId="luna-iframe"+e.cid,e.settings=void 0,e.status={},e}return u=r.View,i(c,u),c.prototype.onSettingsChange=function(t){var o=this,e=void 0===this.settings,n=(this.settings=p(p({},this.settings),t),this.api.hideErrorMessage(),this.settings["Luna.Title"]),r=this.settings["Luna.Subtitle"],t=this.settings["Luna.Layers"];if(e){for(var e=this.api.getProperty("Luna.ILatitude"),a=this.api.getProperty("Luna.ILongitude"),i=this.api.getProperty("Luna.IZoom"),l=document.querySelectorAll("script[src]"),l=_.findLast(l,function(t){return 0<=_.get(t,"src").indexOf("Luna")}),s=_.get(l,"src").split("/"),u="",c=3;c<s.length-1;c++)u=u+"/"+s[c];this.el.innerHTML=y.app({frameID:this.iframeId,lat:e,lng:a,url:u+"/luna/index.html",zoom:i})}this.iframe=this.el.getElementsByClassName(this.iframeId)[0].contentWindow,this.iframe.layers=t;f(o,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return _.isNil(this.iframe.window.luna)?[4,new Promise(function(t){return requestAnimationFrame(t)})]:[3,2];case 1:return t.sent(),[3,0];case 2:return[2,this.iframe]}})}).then(function(a){var t=a.document.querySelector("div.what"),e=(a.layers.forEach(function(e,t){var n=e.LayerId,r=o.api.getProperty("Luna.Layers."+t+".Enabled");e.Enabled=!!r&&e.Enabled,_.isNil(o.status[n])&&e.Enabled&&n&&e.Type&&e.Name&&(o.status[n]={status:"INIT"},r=a.luna.loadLayer(e.Name,e.Type,"./assets/layers/"+n,e.Arg1,e.Arg2,e.Arg3),o.status[n]={layer:r,status:"LOADING"},a.luna.updateLayerName(o.status[n].layer,e.Name)),e.Name&&(a.luna.updateLayerName(o.status[n].layer,e.Name),_.get(a.luna,"layers."+t+".objects"))&&_.each(a.luna.layers[t].objects,function(t){t.visible=e.Enabled}),$(o.iframe.frameElement).contents().find(".layer-bar-title:nth-child("+(t+1)+")").html(e.Name)}),a.luna.registerUpdateCallback(function(t){for(var e=0,n=Object.entries(t);e<n.length;e++){var r=n[e],a=r[0],i=r[1];switch(a){case"timeslider.percent":o.api.setProperty("Luna.Time",i);break;case"lat":o.api.setProperty("Luna.Latitude",i);break;case"lng":o.api.setProperty("Luna.Longitude",i);break;case"zoom":o.api.setProperty("Luna.Zoom",i);break;case"error":o.api.showErrorMessage(i);break;default:console.log("updateCallback presented with unknown update key="+a)}}}),t.querySelector(":scope > div.big")),t=t.querySelector(":scope > div.small");n&&(e.innerHTML=n),r&&(t.innerHTML=r)})},c.prototype.setTheme=function(t){},c.getComponentDefinition=o.getComponentDefinition,c});